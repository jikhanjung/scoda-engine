# P02: S-1 Step 1 계획 — Generic Fixture 전환 (dependency 없는 패키지)

**작성일:** 2026-02-20

---

## Context

SCODA Engine은 도메인 무관 범용 런타임이지만, 테스트 fixture (`test_db`)가 trilobase(삼엽충 분류) 도메인 데이터에 의존하고 있다.
S-1 작업의 첫 단계로, dependency(외부 DB ATTACH) 없이 동작하는 테스트 클래스를 먼저 범용 fixture로 전환한다.

## 목표

1. 도메인 독립적인 `generic_db` / `generic_client` fixture 생성
2. dependency 불필요한 16개 테스트 클래스를 generic fixture로 마이그레이션
3. 기존 `test_db`/`client` fixture는 dependency 필요 테스트용으로 유지

## 변경 대상 파일

- `tests/conftest.py` — `generic_db`, `generic_client` fixture 추가
- `tests/test_runtime.py` — 16개 테스트 클래스 fixture 교체 + assertion 변경

## Generic Fixture 설계

### generic_db 스키마

| 테이블 | 역할 |
|--------|------|
| `categories` | 3단계 계층 (root -> group -> subgroup), 5건 |
| `items` | 리프 레코드 5건 (Gravity, Relativity, Evolution, Photosynthesis, Alchemy) |
| `item_relations` | 아이템 간 관계 1건 (Alchemy superseded_by Relativity) |
| `tags` | 아이템 태그 4건 |
| + SCODA 코어 | artifact_metadata, provenance, schema_descriptions, ui_display_intent, ui_queries, ui_manifest |

- artifact_id: `sample-data`
- Named queries: 11개 (all local, no cross-DB references)
- Manifest views: 4개 (category_tree, items_table, item_detail, category_detail)
- Display intents: 2개

### generic_client

- `generic_db` 기반 TestClient
- `_set_paths_for_testing(canonical, overlay)` — `extra_dbs` 없음

## 전환 대상 클래스 (16개)

**단순 fixture 교체:**
- TestCORS, TestMCPMount, TestOpenAPIDocs, TestIndex
- TestGenericViewer, TestGenericViewerFallback

**fixture + assertion 변경:**
- TestApiProvenance, TestApiDisplayIntent, TestApiQueries
- TestApiQueryExecute, TestApiManifest, TestAnnotations
- TestGenericDetailEndpoint

**Composite/Package 전환:**
- TestCompositeDetail, TestScodaPackage, TestScodaPackageSPA

## 유지 대상 (Step 2)

| 클래스 | 이유 |
|--------|------|
| TestRelease | release.py가 taxonomic_ranks 직접 참조 |
| TestPackageRegistry | ATTACH dependency 테스트 필요 |
| TestDynamicMcpTools | extra_dbs 필요 |
| TestActivePackage | dependency 포함 패키지 설정 |
| TestUIDSchema/PhaseB/PhaseC | trilobase/paleocore UID 포맷 검증 |

## 검증 기준

- `pytest tests/test_runtime.py -v` — 189 passed
- 기존 test_db 사용 테스트도 여전히 통과
