# P02: S-1 Step 2 계획 — Generic Fixture 완전 전환 (dependency 포함)

**작성일:** 2026-02-20

---

## Context

Step 1에서 dependency 없는 16개 테스트 클래스를 `generic_db`/`generic_client`로 전환 완료 (189 passed).
Step 2에서는 나머지 7개 클래스 + straggler 3개 테스트를 전환하고, `release.py`를 범용화한다.

## 변경 대상 파일

- `scripts/release.py` — hardcoded trilobase 참조 제거 (production code)
- `tests/conftest.py` — generic_db에 UID 칼럼 추가, 새 fixture 4개 추가, old fixture 삭제
- `tests/test_runtime.py` — 7개 클래스 + straggler 3개 전환

---

## Part A: release.py 범용화

### `get_statistics(db_path)`
- 하드코딩된 taxonomic_ranks/synonyms/bibliography 쿼리 → auto-discover
- SCODA 메타 테이블 제외한 모든 user 테이블 row count 자동 수집
- `total_records` 합계 추가

### `build_metadata_json(db_path, sha256_hash)`
- default `'trilobase'` → `'unknown'`, `'Trilobase'` → `'Unknown'`

### `generate_readme(version, sha256_hash, stats, artifact_id=None, name=None)`
- title: `"Trilobase v{version}"` → `"{name} v{version}"`
- DB filename: `"trilobase.db"` → `"{artifact_id}.db"`
- stats: 하드코딩 항목 → `stats` dict iteration

### `create_release(db_path, output_dir)`
- artifact_id를 DB에서 읽어서 directory/file naming
- `trilobase-v{version}` → `{artifact_id}-v{version}`
- `trilobase.db` → `{artifact_id}.db`
- `trilobase.scoda` → `{artifact_id}.scoda`

### `main()` dry-run
- artifact_id를 DB에서 읽어서 release directory 계산

---

## Part B: generic_db UID 칼럼 추가

`categories`, `items` 테이블에 `uid, uid_method, uid_confidence, same_as_uid` 추가 + UNIQUE index.
`references` 테이블 신규 추가 (bibliography 대체, UID 포함, 3건).

UID 포맷:
| 테이블 | 포맷 | 예시 |
|--------|------|------|
| categories | `scoda:cat:<level>:<name>` | `scoda:cat:root:Science` |
| items | `scoda:item:name:<name>` | `scoda:item:name:Gravity` |
| references | `scoda:ref:<method>:<value>` | `scoda:ref:fp_v1:sha256:test_newton` |

기존 Step 1 테스트에 영향 없음 (additive change).

---

## Part C: generic_dep_db fixture 신규

paleocore DB 대체. `dep` alias로 ATTACH.

| 테이블 | 역할 (paleocore 대응) |
|--------|----------------------|
| `regions` | countries |
| `locations` | geographic_regions (level: region/subregion) |
| `time_periods` | temporal_ranges |
| `time_mapping` | temporal_ics_mapping |
| `entries` | formations |

모든 테이블에 UID 칼럼 + UNIQUE index + sample data.
SCODA 코어 테이블 포함 (artifact_id='dep-data').

---

## Part D: 지원 fixture 3개

1. **`generic_dep_client`** — `generic_db` + `generic_dep_db`, `extra_dbs={'dep': dep_path}`
2. **`generic_mcp_tools_data`** — items/category_tree/item_detail 참조
3. **`generic_scoda_with_mcp_tools`** — generic_db + generic_mcp_tools_data로 .scoda 생성

---

## Part E: 테스트 클래스 전환 (7+3)

| 클래스 | 테스트 수 | 대상 fixture | 주요 변경 |
|--------|----------|-------------|----------|
| TestRelease | 10 | generic_db | release.py 범용화 후 assertion 변경 |
| TestPackageRegistry | 8 | generic_db + generic_dep_db | trilobase→sample-data, pc→dep |
| TestActivePackage | 2 | generic_db | 단순 테이블/이름 변경 |
| TestDynamicMcpTools | ~20 | generic_db + MCP fixtures | SQL/쿼리명/composite view 변경 |
| TestUIDSchema | 12 | generic_db + generic_dep_db | UID format 전면 재작성 |
| TestUIDPhaseB | 4 | generic_dep_db | regions↔locations 일관성 |
| TestUIDPhaseC | 12 | generic_db + generic_dep_db | references/entries UID |
| Stragglers | 3 | generic_client/generic_db | client→generic_client |

---

## Part F: Old fixture 삭제

모든 테스트 통과 후: `test_db`, `client`, `mcp_tools_data`, `scoda_with_mcp_tools` 삭제.

---

## 실행 순서

1. release.py 범용화 (Part A)
2. conftest.py에 fixture 추가 (Part B + C + D)
3. 테스트 전환 (Part E): 클래스별 순차 전환
4. Old fixture 삭제 (Part F)
5. 전체 `pytest tests/ -v` 통과 확인
